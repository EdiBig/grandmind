## ‚úÖ 1. **Onboarding Strategy**

### üîπ Decision: When to Show Onboarding?

| User Type                       | Show Onboarding?      |
| ------------------------------- | --------------------- |
| **New user (email/pass)**       | ‚úÖ Yes                 |
| **Social sign-in (first time)** | ‚úÖ Yes                 |
| **Returning user**              | ‚ùå No, skip onboarding |

> üîÅ **Exception:** Add a manual ‚ÄúReset onboarding‚Äù option in settings for users who want to reconfigure goals/preferences.

### üîπ How to Track Completion?

Add a `hasCompletedOnboarding: boolean` field in the user profile (`users/{uid}` in Firestore). Default is `false` when created.

---

## ‚úÖ 2. **Auto-Create Minimal User Profile on Login**

### üîπ Best Practice

‚úÖ **Yes, always auto-create** a minimal user profile if it‚Äôs missing. This avoids app crashes and simplifies logic.

Example:

```ts
// Firestore document structure (users/{uid})
{
  uid: 'abc123',
  email: 'john@doe.com',
  createdAt: Timestamp,
  hasCompletedOnboarding: false,
  signInProvider: 'google' | 'email' | 'apple',
  preferences: {},
}
```

> üîê Use Firestore **security rules** to prevent empty or invalid user docs from being written externally.

---

## ‚úÖ 3. **Implementation for Onboarding Check**

### üîπ Pseudocode Logic

```ts
onAuthStateChanged((user) => {
  if (!user) return showLogin();

  const userDoc = await getUserProfile(user.uid);

  if (!userDoc.exists()) {
    await createMinimalUser(user);
    return showOnboarding(); // first-time social sign-in
  }

  if (!userDoc.data().hasCompletedOnboarding) {
    return showOnboarding();
  }

  return showHomeScreen();
});
```

---

## ‚úÖ 4. **Forgot Password Flow ‚Äì Isolated and Lightweight**

### üîπ Goals:

* Clear UX separation from main auth flow
* Stateless, no side effects unless confirmed

### üîπ Flow:

1. User taps ‚ÄúForgot password‚Äù
2. Prompt for email
3. Call `sendPasswordResetEmail(email)`
4. Show ‚ÄúCheck your inbox‚Äù confirmation screen

> üßº **No need to create a user document** in this flow. Only touch Firestore on successful login or sign-up.

---

## ‚úÖ 5. **Firebase Rules + UX Tips**

* Enforce that `hasCompletedOnboarding` must be true before accessing certain protected features (e.g., health data).
* Allow re-onboarding via settings ‚Üí ‚ÄúReset goals/preferences‚Äù
* Log onboarding completion with analytics (`onboarding_completed` event)

---

## üö´ Don‚Äôt Do This

* ‚ùå Don‚Äôt block social sign-in users from entering the app just because a profile doc is missing
* ‚ùå Don‚Äôt store onboarding state in local storage alone‚Äîmust persist in Firestore
* ‚ùå Don‚Äôt mix forgot password UI into the main login/signup logic tree‚Äîkeep it modular

---

1. Auto-Create Minimal User Profile + Onboarding Check
Future<void> handleUserAuth(User firebaseUser) async {
  final userRef = FirebaseFirestore.instance.collection('users').doc(firebaseUser.uid);
  final doc = await userRef.get();

  if (!doc.exists) {
    // Create minimal profile for first-time sign-ins
    await userRef.set({
      'uid': firebaseUser.uid,
      'email': firebaseUser.email,
      'createdAt': FieldValue.serverTimestamp(),
      'hasCompletedOnboarding': false,
      'signInProvider': firebaseUser.providerData.first.providerId,
    });
    // Navigate to onboarding
    navigatorKey.currentState?.pushReplacementNamed('/onboarding');
    return;
  }

  final data = doc.data()!;
  if (data['hasCompletedOnboarding'] != true) {
    navigatorKey.currentState?.pushReplacementNamed('/onboarding');
    return;
  }

  // User is onboarded ‚Äî go to main app
  navigatorKey.currentState?.pushReplacementNamed('/home');
}


Use inside an onAuthStateChanged listener:
FirebaseAuth.instance.authStateChanges().listen((user) {
  if (user != null) {
    handleUserAuth(user);
  } else {
    navigatorKey.currentState?.pushReplacementNamed('/login');
  }
});

2. Mark Onboarding as Complete
Future<void> completeOnboarding(User user) async {
  await FirebaseFirestore.instance
      .collection('users')
      .doc(user.uid)
      .update({'hasCompletedOnboarding': true});
}

Call it at the end of the onboarding flow, then navigate:

await completeOnboarding(FirebaseAuth.instance.currentUser!);
Navigator.of(context).pushReplacementNamed('/home');

3. Forgot Password Flow

Lightweight screen:

class ForgotPasswordScreen extends StatefulWidget {
  @override
  _ForgotPasswordScreenState createState() => _ForgotPasswordScreenState();
}

class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {
  final _emailController = TextEditingController();
  bool _emailSent = false;

  void _sendResetLink() async {
    final email = _emailController.text.trim();

    try {
      await FirebaseAuth.instance.sendPasswordResetEmail(email: email);
      setState(() => _emailSent = true);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Error: ${e.toString()}')));
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Reset Password')),
      body: _emailSent
          ? Center(child: Text('Check your email for a reset link.'))
          : Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                children: [
                  TextField(
                    controller: _emailController,
                    decoration: InputDecoration(labelText: 'Email'),
                  ),
                  SizedBox(height: 20),
                  ElevatedButton(
                    onPressed: _sendResetLink,
                    child: Text('Send Reset Link'),
                  ),
                ],
              ),
            ),
    );
  }
}

 Firestore Rule Snippet

match /users/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}

