rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Enforce immutable userId field on updates
    function isUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // Enforce immutable createdBy field on updates
    function isCreatedByImmutable() {
      return request.resource.data.createdBy == resource.data.createdBy;
    }

    // Enforce immutable uid field on user docs (allow setting if missing)
    function isUidImmutable() {
      return resource.data.uid == null ||
             request.resource.data.uid == resource.data.uid;
    }

    // Users collection - users can only read/write their own data
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if false;

      // Notification preferences subcollection
      match /notification_preferences/{preferenceId} {
        allow read, write: if isOwner(userId);
      }

      // Notification history subcollection
      match /notification_history/{historyId} {
        allow read, write: if isOwner(userId);
      }

      // Workout favorites subcollection
      match /workout_favorites/{favoriteId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Workouts collection - public templates + user workouts
    match /workouts/{workoutId} {
      allow read: if isAuthenticated() &&
                    (resource.data.createdBy == request.auth.uid ||
                     resource.data.createdBy == null);
      allow create: if isAuthenticated() &&
                     request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.createdBy == request.auth.uid &&
                              isCreatedByImmutable();
    }

    // Workout logs collection - users can only access their own workout logs
    match /workout_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Habits collection - users can only access their own habits
    match /habits/{habitId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Habit logs collection - users can only access their own habit logs
    match /habit_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Progress collection - users can only access their own progress
    match /progress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Health data collection - users can only access their own health data
    match /health_data/{healthId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Weight entries collection - users can only access their own weight data
    match /weight_entries/{entryId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Measurement entries collection - users can only access their own measurements
    match /measurement_entries/{entryId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Progress photos collection - users can only access their own photos
    match /progress_photos/{photoId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Progress goals collection - users can only access their own goals
    match /progress_goals/{goalId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Notification schedules collection - users can only access their own schedules
    match /notification_schedules/{scheduleId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Notification logs collection - users can only read their own logs
    match /notification_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid &&
                     isUserIdImmutable();
    }

    // Meals collection - users can only access their own meals
    match /meals/{mealId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Water logs collection - users can only access their own water logs
    match /water_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Nutrition goals collection - users can only access their own goals
    match /nutrition_goals/{goalId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Food items collection - read: own items OR shared/public foods, write: only owner
    match /food_items/{foodId} {
      // Allow reading own food items OR shared foods (isCustom=false or no userId)
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.isCustom == false ||
        resource.data.userId == null
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Saved workouts collection - users can only access their own saved items  
    match /user_saved_workouts/{savedWorkoutId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Mood & energy logs collection
    match /mood_energy_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // AI cache collection - users can only access their own cached responses
    match /ai_cache/{cacheId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // AI conversations collection - users can only access their own conversations
    match /ai_conversations/{conversationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Personal bests collection - users can only access their own personal bests
    match /personal_bests/{bestId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Milestones collection - users can only access their own milestones
    match /milestones/{milestoneId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Sync status collection - read-only for authenticated users (written by Cloud Functions)
    match /sync_status/{statusId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only Cloud Functions (admin SDK) can write
    }

    // Community challenges (Unity) collection
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.createdBy == request.auth.uid;
      // Allow creator to update all fields, OR allow any authenticated user
      // to only update participantCount (for join/leave operations)
      allow update: if isAuthenticated() && (
        // Creator can update anything
        (resource.data.createdBy == request.auth.uid && isCreatedByImmutable()) ||
        // Non-creators can only update participantCount
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participantCount']))
      );
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // Unity challenge participants collection
    match /challengeParticipants/{participantId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Challenge consents collection - GDPR consent tracking
    match /challengeConsents/{consentId} {
      allow read: if isAuthenticated() && consentId == request.auth.uid;
      allow create: if isAuthenticated() && consentId == request.auth.uid;
      allow update: if isAuthenticated() && consentId == request.auth.uid;
      allow delete: if isAuthenticated() && consentId == request.auth.uid;
    }

    // Challenge activities collection - activity feed
    match /challengeActivities/{activityId} {
      // Anyone in a challenge can read activities (privacy filtered in app)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid ||
                       // Allow adding encouragement
                       (request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['encouragementCount', 'encouragedBy'])));
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Consent audit log - write-only for users (for audit trail)
    match /consentAuditLog/{logId} {
      allow read: if false; // Only admin can read audit logs
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Audit logs are immutable
    }

    // Consent withdrawal requests
    match /consentWithdrawalRequests/{requestId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Processed by admin/Cloud Functions
    }

    // Data deletion log - write-only
    match /dataDeletionLog/{logId} {
      allow read: if false; // Only admin
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Immutable
    }

    // Challenge progress entries
    match /challengeProgress/{progressId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
                              resource.data.userId == request.auth.uid &&
                              isUserIdImmutable();
    }

    // Challenge milestones
    match /challengeMilestones/{milestoneId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      isUserIdImmutable();
      allow delete: if false; // Milestones are permanent achievements
    }

    // Challenge invitations
    match /challengeInvitations/{invitationId} {
      // Users can read invitations they sent or received
      allow read: if isAuthenticated() &&
                    (resource.data.inviterId == request.auth.uid ||
                     resource.data.inviteeId == request.auth.uid);
      // Users can create invitations (as inviter)
      allow create: if isAuthenticated() &&
                      request.resource.data.inviterId == request.auth.uid;
      // Users can update invitations they received (to accept/decline)
      allow update: if isAuthenticated() &&
                      resource.data.inviteeId == request.auth.uid;
      allow delete: if false;
    }

    // Challenge invite links
    match /challengeInviteLinks/{linkId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                      request.resource.data.creatorId == request.auth.uid;
      allow update: if isAuthenticated() &&
                      resource.data.creatorId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.creatorId == request.auth.uid;
    }

    // Challenge notifications
    match /challengeNotifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // Challenge notification preferences
    match /challengeNotificationPrefs/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Push notification queue (write-only for app, processed by Cloud Functions)
    match /pushNotificationQueue/{queueId} {
      allow read: if false;
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // Challenge reports
    match /challengeReports/{reportId} {
      // Users can read their own reports
      allow read: if isAuthenticated() && resource.data.reporterId == request.auth.uid;
      // Users can create reports
      allow create: if isAuthenticated() &&
                      request.resource.data.reporterId == request.auth.uid;
      // Only admin/Cloud Functions can update reports
      allow update, delete: if false;
    }

    // Blocked users
    match /blockedUsers/{blockId} {
      // Users can see who they blocked
      allow read: if isAuthenticated() && resource.data.blockerId == request.auth.uid;
      // Users can block others
      allow create: if isAuthenticated() &&
                      request.resource.data.blockerId == request.auth.uid;
      // Users can unblock
      allow delete: if isAuthenticated() &&
                      resource.data.blockerId == request.auth.uid;
      allow update: if false;
    }

    // Challenge moderation settings (for challenge creators)
    match /challengeModerationSettings/{challengeId} {
      // Anyone in challenge can read settings
      allow read: if isAuthenticated();
      // Only challenge creator can modify (validated in app code)
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }

    // Moderation action logs (audit trail)
    match /moderationLogs/{logId} {
      allow read: if false; // Only admin
      allow create: if isAuthenticated();
      allow update, delete: if false; // Immutable
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
